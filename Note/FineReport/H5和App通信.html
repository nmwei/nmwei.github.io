<!DOCTYPE html>
<html>
    <head>
        <title>查看源</title>
        <meta charset="UTF-8">
        <link rel="canonical" href="/pages/viewpage.action?pageId=8981193" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
</script>
<link type="text/css" rel="stylesheet" href="/s/fb09ad6efee8cbbb0199de5508fc7a0f-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/22/_/download/superbatch/css/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/22/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/22/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/27e53ccd09b1bbdc42068705db2d86c9/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="/s/b1f8784148f8fbef60357d1b60a91246-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/02a416b33820397aa1d11efd481f9223/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/02a416b33820397aa1d11efd481f9223/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="/s/f4a0dceb76a353664cfce6bacac90eab-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/12c9241ca467c86b864cf126220523c8/_/download/contextbatch/css/editor-content/batch.css?confluence.view.edit.transition=true" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/12c9241ca467c86b864cf126220523c8/_/download/contextbatch/css/editor-content/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-T/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/1.5.4/_/download/batch/io.moewe.confluence.addons.rate:content-rating-resources/io.moewe.confluence.addons.rate:content-rating-resources.css" media="all">
<link type="text/css" rel="stylesheet" href="/s/zh_CN/6211/3938a2601e8fc8d1decf2078567a8651fae8f539.10/1/_/styles/colors.css" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <h2>描述</h2><p>H5报表集成在App的时候有需求和App之间通信，从最早的消息加解密，超链App打开，自定义加载，到现在的App实现H5工具栏。这边代码结构上需要设计下。</p><h2>原始方案</h2><p>最早这种通信比较少，碰到一个，就在App上定义一个XXHandler，H5端通过XXHandler去处理消息。这样Handler多了以后，对集成使用者很不友好，出了问题还需要先找到哪个handler。而且每个App的handler可能都会对H5发送回调方法，这样又在H5端定义很多处理App消息的Handler，H5里处理App消息的代码也会分散在各处，代码混乱。</p><h2>替代方案</h2><p>消息统一管理，通过类型和参数来定义一个消息</p><p>App端只需要定义一个Handler来处理所有H5过来的消息；同样H5也只定义一个Handler来接收App过来的消息。</p><h3>Handler名称</h3><p>H5端注册，App端触发的Handler名称: <span style="color: rgb(51,51,51);">AppMessageHandler</span></p><p>App端注册，H5端触发的Handler名称: H5MessageHandler</p><h3>参数传递</h3><ol><li>action <br />action = { <br />        type: actionType, //消息类型<p>        data: actionData //传递的数据</p>}</li><li><p>callback //回调函数</p></li></ol><p>注意: H5与App通讯时，传递两个参数，第一个参数为action事件对象，第二个参数为callback回调函数</p><p>         action事件对象包括两个键值对，一个为type消息类型，第二个为data传递的数据。</p><p>         action.type消息类型为必选参数，action.data传递的数据为可选参数，callback回调函数为可选参数。</p><h3>注册方式</h3><p>      1. H5端注册事件</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="c842681b-1aae-4e00-9234-bf04ca849ab6" data-macro-parameters="language=js" data-macro-schema-version="1" style="background-image: url(/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGU6bGFuZ3VhZ2U9anN9&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>  //iOS
  jsBridge.registerHandler("AppMessageHandler", function(action, callback){
        //TODO
  });
  //Android
  jsBridge.AppMessageHandler = function(action, callback){
        //TODO
  });</pre></td></tr></table><p>     2. H5端触发事件</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="ee0f687e-3203-4ac2-beb7-4f7748399317" data-macro-parameters="language=js" data-macro-schema-version="1" style="background-image: url(/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NvZGU6bGFuZ3VhZ2U9anN9&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre> //iOS  
 jsBridge.callHandler("H5MessageHandler", action, callback);
 //Android
 jsBridge.H5MessageHandler(action, callback);</pre></td></tr></table><h2>消息列表</h2><h3>H5注册、App调用的消息</h3><table class="confluenceTable"><tbody><tr><th colspan="1" class="confluenceTh">消息分类</th><th colspan="1" style="text-align: center;" class="confluenceTh">消息名称</th><th style="text-align: center;" class="confluenceTh">消息类型</th><th colspan="1" class="confluenceTh">其他参数</th><th style="text-align: center;" class="confluenceTh">描述</th><th colspan="1" class="confluenceTh">触发条件</th></tr><tr><td rowspan="7" class="confluenceTd"><p> </p><p> </p><p> </p><p>H5底部工具栏接口</p></td><td colspan="1" style="text-align: left;" class="confluenceTd">上一页</td><td style="text-align: left;" class="confluenceTd">gotoPreviousPage</td><td colspan="1" style="text-align: left;" class="confluenceTd">无</td><td style="text-align: left;" class="confluenceTd"><p>报表翻到前一页</p></td><td colspan="1" style="text-align: left;" class="confluenceTd">报表有多页，且当前页不是首页</td></tr><tr><td colspan="1" style="text-align: left;" class="confluenceTd"><span>弹出分页框</span></td><td colspan="1" style="text-align: left;" class="confluenceTd"><p><span>showPaginationModal</span></p></td><td colspan="1" style="text-align: left;" class="confluenceTd">无</td><td colspan="1" style="text-align: left;" class="confluenceTd"><span>报表弹出分页框</span></td><td colspan="1" style="text-align: left;" class="confluenceTd"><span>报表有多页</span></td></tr><tr><td colspan="1" style="text-align: left;" class="confluenceTd">下一页</td><td style="text-align: left;" class="confluenceTd">gotoNextPage</td><td colspan="1" style="text-align: left;" class="confluenceTd">无</td><td style="text-align: left;" class="confluenceTd">报表翻到下一页</td><td colspan="1" style="text-align: left;" class="confluenceTd"><span>报表有多页，且当前页不是尾页</span></td></tr><tr><td colspan="1" style="text-align: left;" class="confluenceTd">刷新</td><td colspan="1" style="text-align: left;" class="confluenceTd">refresh</td><td colspan="1" style="text-align: left;" class="confluenceTd">无</td><td colspan="1" style="text-align: left;" class="confluenceTd">报表/表单刷新</td><td colspan="1" style="text-align: left;" class="confluenceTd">在设计器模板移动端属性工具栏选中刷新按钮</td></tr><tr><td colspan="1" style="text-align: left;" class="confluenceTd">返回参数面板</td><td colspan="1" style="text-align: left;" class="confluenceTd">showFilter</td><td colspan="1" style="text-align: left;" class="confluenceTd"><p>callback</p></td><td colspan="1" style="text-align: left;" class="confluenceTd"><p>报表/表单返回参数面板</p></td><td colspan="1" style="text-align: left;" class="confluenceTd"><p>报表/表单有参数面板</p></td></tr><tr><td colspan="1" style="text-align: left;" class="confluenceTd">放大</td><td colspan="1" style="text-align: left;" class="confluenceTd">zoomIn</td><td colspan="1" style="text-align: left;" class="confluenceTd">无</td><td colspan="1" style="text-align: left;" class="confluenceTd">报表放大</td><td colspan="1" style="text-align: left;" class="confluenceTd">在设计器模板移动端属性工具栏选中缩放按钮</td></tr><tr><td colspan="1" style="text-align: left;" class="confluenceTd">缩小</td><td colspan="1" style="text-align: left;" class="confluenceTd">zoomOut</td><td colspan="1" style="text-align: left;" class="confluenceTd">无</td><td colspan="1" style="text-align: left;" class="confluenceTd">报表缩小</td><td colspan="1" style="text-align: left;" class="confluenceTd"><span>在设计器模板移动端属性工具栏选中缩放按钮</span></td></tr></tbody></table><p> </p><h3>App注册、H5调用的消息</h3><table class="confluenceTable"><tbody><tr><th class="confluenceTh">消息分类</th><th class="confluenceTh">消息名称</th><th class="confluenceTh">消息类型</th><th colspan="1" class="confluenceTh">其他参数</th><th colspan="1" class="confluenceTh">描述</th><th colspan="1" class="confluenceTh">触发条件</th></tr><tr><td rowspan="2" class="confluenceTd"><br /><br />H5工具栏接口</td><td colspan="1" class="confluenceTd"><p> </p><p>处理工具栏</p></td><td colspan="1" class="confluenceTd"><p> </p><p>showToolbarItems</p></td><td colspan="1" class="confluenceTd"><p> data:{ //H5工具栏的信息</p><p>}</p><p>callback</p></td><td colspan="1" class="confluenceTd"><p>告诉App当前h5工具栏有哪些功能</p><p>App生成原生工具栏，实现H5工具栏的功能</p></td><td rowspan="5" class="confluenceTd"><p> </p><p> </p><p> </p><p> </p><p>App端注册的Handler有对应消息类型的处理逻辑</p><p><br /><br /><br /><br /></p></td></tr><tr><td class="confluenceTd">更新页码</td><td class="confluenceTd">updatePageNumber</td><td colspan="1" class="confluenceTd"><p>data: {//翻页成功之后的页码</p><p>}</p></td><td colspan="1" class="confluenceTd">告诉app当前报表所在页的页码</td></tr><tr><td rowspan="3" class="confluenceTd"><p> </p><p>其他</p></td><td colspan="1" class="confluenceTd"><span>超链</span></td><td colspan="1" class="confluenceTd"><span>hyperLinkHandler</span></td><td colspan="1" class="confluenceTd"><p>data:{</p><p>url: hyperLinkUrl,<br /> name: hyperLinkName</p><p>}</p></td><td colspan="1" class="confluenceTd"><p> App处理超链</p></td></tr><tr><td colspan="1" class="confluenceTd"><span>开启加载动画</span></td><td colspan="1" class="confluenceTd"><span>showLoadingHandler</span></td><td colspan="1" class="confluenceTd">无</td><td colspan="1" class="confluenceTd"> App开启加载动画</td></tr><tr><td colspan="1" class="confluenceTd">关闭加载动画</td><td colspan="1" class="confluenceTd">hideLoadingHandler</td><td colspan="1" class="confluenceTd">无</td><td colspan="1" class="confluenceTd"> App关闭加载动画</td></tr></tbody></table><h2>举例</h2><h3>H5底部工具栏接口</h3><h4><span>showToolbarItems——生成App原生工具栏</span></h4><ol><li>用户在设计器制作模板，并选择H5解析，在App打开H5报表。</li><li>H5代码执行，生成对应页面，并根据后台传递的数据确定当前模板应该有的H5工具栏按钮。</li><li>H5发送showToolbarItems消息，并传递data——h5工具栏信息，callback——回调函数。</li><li>App收到H5发送的工具栏信息data，创建App原生工具栏，创建成功之后执行callback，并传递参数。</li><li>callback被执行，H5端Web工具栏不再显示。</li></ol><h4><span>gotoPreviousPage——上一页</span></h4><ol><li><span>App端发送<span>gotoPreviousPage消息。</span></span></li><li><span><span>H5根据当前页以及总页码执行翻页操纵。</span></span></li><li>翻页成功之后H5发送<span>updatePageNumber消息，传递data翻页之后的页码。</span></li><li>App更改原生工具栏页码。</li></ol><h4><span>showFilter ——返回参数面板</span></h4><ol><li><span> </span>App发送showFilter消息，传递callback回调。</li><li>H5端<span>返回参数面板。</span></li><li>返回参数面板之后触发App中定义的callback回调。</li><li>App中隐藏原生工具栏。   </li></ol><p> </p><p> </p>
        <p>&nbsp;</p>
    </body>
</html>
